<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Cálculo de Supervisório</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: Bento Aurora -->
    <!-- Application Structure Plan: This version introduces project time estimation. The data structure for each item now includes a 'time' property. The "Cadastros" tab is updated with an input field to edit this time. The summary dashboard now features a new "Bento Grid" card to display the "Total de Horas Estimadas" in real-time. The calculator logic aggregates both tags and time, providing a more comprehensive project estimate. -->
    <!-- Visualization & Content Choices: Report Info: Project Time -> Goal: Allow user input and display total -> Viz/Method: Added time input fields in the "Cadastros" tab and a new summary card in the dashboard. Justification: This is a major functional enhancement that provides a second key metric for project planning, directly addressing user needs. | Report Info: UI Layout -> Goal: Accommodate new information without clutter -> Viz/Method: The CSS grid for input rows was adjusted to include a new column for time, maintaining a clean and organized layout. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        :root {
            /* Light Theme */
            --bg-color: #f4f7f9;
            --card-bg-color: rgba(255, 255, 255, 0.7);
            --border-color: rgba(0, 0, 0, 0.1);
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --accent-color: #14b8a6; /* New Teal Color */
            --accent-hover: #0d9488;
            --danger-color: #dc2626;
            --success-color: #16a34a;
            --legend-color: var(--text-primary);
            --input-bg: #ffffff;
            --input-border: #cbd5e1;
            --aurora-start: var(--accent-color);
            --aurora-end: #2563eb;
            --select-arrow: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%234a5568' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            --total-card-bg: var(--accent-color);
            --total-card-text: #ffffff;
        }

        body.dark-theme {
            /* Dark Theme - More Grayscale */
            --bg-color: #171717;
            --card-bg-color: rgba(38, 38, 38, 0.6);
            --border-color: rgba(255, 255, 255, 0.15);
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --accent-color: #e5e5e5;
            --accent-hover: #ffffff;
            --danger-color: #ef4444; /* Kept for semantic meaning */
            --success-color: #22c55e; /* Kept for semantic meaning */
            --legend-color: var(--text-primary);
            --input-bg: #262626;
            --input-border: #525252;
            --aurora-start: #404040;
            --aurora-end: #262626;
            --select-arrow: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23a3a3a3' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
            --total-card-bg: var(--accent-color);
            --total-card-text: #171717;
        }

        @keyframes aurora {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            transition: background-color 0.5s ease, color 0.5s ease;
        }

        .aurora-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(125deg, var(--aurora-start), var(--bg-color) 40%, var(--aurora-end));
            background-size: 200% 200%;
            animation: aurora 15s ease infinite;
            opacity: 0.15;
            transition: background 0.5s ease;
        }

        .main-container {
            max-width: 1500px;
            margin: 0 auto;
            padding: 2rem 1.5rem;
        }

        .glass-card {
            background: var(--card-bg-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
            border-radius: 1rem;
            padding: 1.5rem 2rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background-color 0.5s ease, border-color 0.5s ease;
        }

        legend {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--legend-color);
            transition: color 0.5s ease;
            padding: 0 0.5rem;
            margin-left: -0.5rem;
        }

        .input-row, .settings-row, .project-input-row {
            display: grid;
            align-items: center;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.5s ease;
        }
        .input-row { grid-template-columns: 1fr 80px 80px 100px; gap: 1rem; }
        .settings-row { grid-template-columns: 1fr 100px 100px; gap: 1rem; }
        .module-settings-row { grid-template-columns: 1fr 80px 80px 80px; gap: 1rem; }
        .project-input-row { grid-template-columns: 1fr; gap: 0.5rem; }
        .two-col-row { grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
        .vc-settings-row { grid-template-columns: 1fr 1fr 100px; gap: 1rem; }


        .calc-grid-header, .settings-grid-header {
            display: grid;
            align-items: center;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.5s ease;
        }
        .calc-grid-header {
            grid-template-columns: 1fr 80px 80px 100px;
            gap: 1rem;
        }
        .settings-grid-header {
            grid-template-columns: 1fr 100px 100px;
            gap: 1rem;
        }
         .module-settings-header {
             grid-template-columns: 1fr 80px 80px 80px;
             gap: 1rem;
         }
        
        .input-row:last-child, .settings-row:last-child, .project-input-row:last-child { border-bottom: none; }
        .input-row:hover, .settings-row:hover, .project-input-row:hover { background-color: rgba(255, 255, 255, 0.03); }
        .input-row label, .settings-row label, .project-input-row label { font-size: 0.95rem; color: var(--text-secondary); transition: color 0.5s ease; }
        .input-row .tags-per-item, .input-row .time-per-item { font-weight: 600; text-align: center; color: var(--accent-color); transition: color 0.5s ease; }
        
        input[type="number"], input[type="text"], select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--input-border);
            border-radius: 0.5rem;
            text-align: center;
            background-color: var(--input-bg);
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        select { 
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: var(--select-arrow);
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.25em 1.25em;
            padding-left: 0.75rem;
            padding-right: 2.5rem;
            text-align: left; 
        }
        input:focus, select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 25%, transparent);
        }

        .summary-panel {
            position: sticky;
            top: 2rem;
            display: grid;
            gap: 1rem;
            grid-template-columns: 1fr 1fr;
        }
        #total-card { grid-column: 1 / span 1; }
        #time-card { grid-column: 2 / span 1; }
        #hardware-card, #travel-card { grid-column: 1 / -1; }
        #license-card { grid-column: 1 / -1; }
        #chart-card { grid-column: 1 / -1; }
        #actions-card { grid-column: 1 / -1; }
        
        .summary-value { font-size: 2.5rem; font-weight: 700; line-height: 1.1; color: var(--text-primary); text-shadow: 0 0 15px color-mix(in srgb, var(--accent-color) 50%, transparent); transition: all 0.5s ease; }
        .summary-label { display: block; font-size: 0.9rem; color: var(--text-secondary); }
        .sub-value { font-size: 0.85rem; color: var(--text-secondary); }
        .license-name { font-size: 1.1rem; font-weight: 600; color: var(--text-primary); }
        .price-value { font-size: 1.25rem; font-weight: 700; color: var(--success-color); }
        .project-total-price { font-size: 1.75rem; font-weight: 700; color: var(--total-card-text); }
        .hardware-item, .travel-item { display: flex; justify-content: space-between; font-size: 0.9rem; padding: 0.25rem 0; }
        #project-total-card {
            background-color: var(--total-card-bg);
            transition: background-color 0.5s ease;
        }
        #project-total-card .summary-label {
            color: var(--total-card-text);
            opacity: 0.8;
        }
        #project-total-card .project-total-price {
            color: var(--total-card-text);
        }

        .action-button { width: 100%; padding: 0.75rem; border: none; border-radius: 0.75rem; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
        .save-button { background-color: var(--success-color); box-shadow: 0 4px 20px -5px color-mix(in srgb, var(--success-color) 40%, transparent); }
        .clear-button { background-color: var(--danger-color); box-shadow: 0 4px 20px -5px color-mix(in srgb, var(--danger-color) 40%, transparent); }
        .action-button:hover { transform: translateY(-2px); filter: brightness(1.1); }
        
        #chart-container { position: relative; height: 240px; }

        .tab-button { padding: 0.75rem 1.5rem; border: none; background: transparent; color: var(--text-secondary); font-weight: 500; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .tab-button.active { color: var(--text-primary); }
        .tab-button::after { content: ''; position: absolute; bottom: 0; left: 50%; transform: translateX(-50%); width: 0; height: 2px; background-color: var(--accent-color); transition: width 0.3s ease; }
        .tab-button.active::after { width: 40%; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        #theme-switcher {
            background: var(--card-bg-color);
            border: 1px solid var(--border-color);
            border-radius: 999px;
            padding: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        #theme-switcher:hover { transform: scale(1.1); box-shadow: 0 0 15px color-mix(in srgb, var(--accent-color) 30%, transparent); }
        #theme-switcher svg { width: 1.25rem; height: 1.25rem; color: var(--text-secondary); }

        .main-title {
            transition: color 0.5s ease;
        }
        body:not(.dark-theme) .main-title {
            background: linear-gradient(to right, #14b8a6, #0f766e);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        /* Toggle Switch */
        .toggle-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--input-border); transition: .4s; border-radius: 24px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--success-color); }
        input:checked + .slider:before { transform: translateX(20px); }
    </style>
</head>
<body class="dark-theme">
    <div class="aurora-background"></div>
    <div class="main-container">
        <header class="text-center mb-12 relative">
            <h1 class="main-title text-5xl font-bold">Ferramenta de Cálculo de Supervisório</h1>
            <p class="text-lg text-slate-400 mt-4">Estime com precisão as tags, horas e módulos necessários para seu projeto de supervisório.</p>
            <button id="theme-switcher" class="absolute top-0 right-0">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" /></svg>
                <svg id="moon-icon" class="hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25c0 5.385 4.365 9.75 9.75 9.75 2.572 0 4.92-.99 6.697-2.643z" /></svg>
            </button>
        </header>

        <div class="grid md:grid-cols-3 gap-8 items-start">
            <main class="md:col-span-2">
                <div class="tabs mb-2">
                    <button class="tab-button active" onclick="openTab(event, 'calculadora')">Calculadora</button>
                    <button class="tab-button" onclick="openTab(event, 'cadastros')">Cadastros</button>
                </div>
                
                <div id="calculadora" class="tab-content active">
                    <form id="tags-form" class="space-y-4">
                        <div id="calculator-project-inputs"></div>
                        <div id="modules-container"></div>
                        <div id="calculator-fields-container" class="space-y-4"></div>
                    </form>
                </div>

                <div id="cadastros" class="tab-content">
                    <div class="glass-card !rounded-t-none">
                         <div id="settings-fields"></div>
                         <div class="mt-8" id="module-settings-fields"></div>
                         <div class="mt-8" id="license-settings-fields"></div>
                         <div class="mt-8" id="hardware-settings-fields"></div>
                         <div class="flex gap-4 mt-8">
                            <button id="save-settings-button" class="action-button save-button">Salvar Alterações</button>
                            <button id="restore-defaults-button" class="action-button clear-button">Restaurar Padrões</button>
                        </div>
                    </div>
                </div>
            </main>

            <aside class="md:col-span-1">
                 <div class="pt-[52px]">
                    <h2 class="text-xl font-bold mb-2 text-center text-[var(--text-secondary)]">Dashboard</h2>
                    <div class="summary-panel">
                        <div id="total-card" class="glass-card text-center">
                            <span class="summary-label">Total de Tags</span>
                            <span class="summary-value" id="grand-total">0</span>
                            <div class="text-sm sub-value mt-1">
                                <span>Projeto: <span id="base-tags">0</span></span>
                                <span class="block">Reserva: <span id="reserve-tags">0</span></span>
                            </div>
                        </div>
                        <div id="time-card" class="glass-card text-center">
                            <span class="summary-label">Total de Horas</span>
                            <span class="summary-value" id="total-hours">0</span>
                        </div>
                        <div id="hardware-card" class="glass-card">
                             <span class="summary-label text-center">Hardware</span>
                             <div class="mt-2 space-y-2">
                                <div class="hardware-item"><span>Computador:</span><span id="computer-name">N/A</span></div>
                                <div class="hardware-item"><span>Telas:</span><span id="screens-desc">N/A</span></div>
                                <div class="hardware-item"><span>Placa de Vídeo Extra:</span><span id="videocard-desc">N/A</span></div>
                                 <div class="hardware-item"><span>Adicional (Módulos):</span><span id="module-hardware-price">R$ 0,00</span></div>
                                <div class="text-right mt-2 pt-2 border-t border-[var(--border-color)]">
                                    <span class="price-value" id="hardware-total-price">R$ 0,00</span>
                                </div>
                             </div>
                        </div>
                        <div id="travel-card" class="glass-card">
                             <span class="summary-label text-center">Despesas de Viagem</span>
                             <div class="mt-2 space-y-2">
                                <div class="travel-item"><span>Deslocamento:</span><span id="travel-cost">R$ 0,00</span></div>
                                <div class="travel-item"><span>Hospedagem:</span><span id="lodging-cost">R$ 0,00</span></div>
                                <div class="travel-item"><span>Alimentação:</span><span id="food-cost">R$ 0,00</span></div>
                                <div class="text-right mt-2 pt-2 border-t border-[var(--border-color)]">
                                    <span class="price-value" id="travel-total-price">R$ 0,00</span>
                                </div>
                             </div>
                        </div>
                        <div id="license-card" class="glass-card text-center">
                            <span class="summary-label">Licença e Serviços</span>
                            <div class="mt-2">
                                <span id="license-name" class="license-name">N/A</span>
                            </div>
                            <div class="flex justify-around items-center mt-3 text-sm">
                                <div>
                                    <span class="summary-label">Licença</span>
                                    <span id="license-price" class="price-value block">R$ 0,00</span>
                                </div>
                                 <div>
                                    <span class="summary-label">Serviços</span>
                                    <span id="services-price" class="price-value block">R$ 0,00</span>
                                </div>
                            </div>
                        </div>
                         <div id="project-total-card" class="glass-card text-center">
                             <span class="summary-label">Valor Total do Projeto</span>
                            <span id="project-total-price" class="project-total-price !text-4xl">R$ 0,00</span>
                        </div>
                         <div id="chart-card" class="glass-card">
                             <div id="chart-container"><canvas id="tagsChart"></canvas></div>
                        </div>
                        <div id="actions-card" class="glass-card !p-4">
                            <button id="pdf-button" class="action-button save-button mb-2">Gerar Orçamento em PDF</button>
                            <button id="clear-button" class="action-button clear-button">Limpar Calculadora</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>
        <footer class="text-center mt-12 text-sm text-[var(--text-secondary)]">
            <p>Versão 12.0 - by Diego Karloh</p>
        </footer>
    </div>

    <script>
        // --- DATA ---
        let database = {};

        const defaultDatabase = {
            projectSettings: {
                companyName: '',
                projectName: '',
                city: '',
                state: '',
                distance: 0,
                lodgingCount: 0,
                foodDays: 0,
                kmPrice: 0.75,
                lodgingPrice: 350,
                foodPrice: 100,
                reservePercentage: 10,
                screenCount: 0,
                screenModelIndex: 0,
                hourPrice: 150,
                includeComputer: false,
            },
            tags: {
                'motores': {
                    label: 'Motores',
                    items: {
                        'motor_hidr_inversor': { label: 'Motor c/ unid. hidráulica e inversor', tags: 24, time: 2.5 },
                        'motor_hidr_direta': { label: 'Motor c/ unid. hidráulica e partida direta', tags: 22, time: 2 },
                        'motor_direta_sensor': { label: 'Motor c/ partida direta e sensor', tags: 18, time: 1.5 },
                        'motor_direta_simples': { label: 'Motor com partida direta simples', tags: 17, time: 1 },
                        'motor_inversor_simples': { label: 'Motor com partida inversor simples', tags: 20, time: 1.5 },
                        'motor_inversor_reversao': { label: 'Motor c/ partida inversor e reversão', tags: 21, time: 2 }
                    }
                },
                'instrumentos': {
                    label: 'Instrumentos',
                    items: {
                        'instr_digital': { label: 'Instrumentação Digital', tags: 2, time: 0.25 },
                        'instr_analogico': { label: 'Instrumentação Analógica', tags: 4, time: 0.5 }
                    }
                },
                'valvulas': {
                    label: 'Válvulas e Dampers',
                    items: {
                        'valvula_descarga_fundo': { label: 'Válvula descarga fundo', tags: 4, time: 0.75 },
                        'sensor_valvula_incendio': { label: 'Config. por sensor válvula incêndio', tags: 3, time: 1 },
                        'damper': { label: 'Damper', tags: 4, time: 0.5 },
                        'valvulas_geral': { label: 'Válvulas (Geral)', tags: 4, time: 0.5 }
                    }
                },
                'controles': {
                    label: 'Configurações e Controles',
                    items: {
                        'cfg_descarga_fundo': { label: 'Config. padrão válvula descarga', tags: 10, time: 2, max: 1 },
                        'cfg_soprador_fuligem': { label: 'Config. padrão soprador de fuligem', tags: 6, time: 3, max: 1 },
                        'cfg_valvula_incendio': { label: 'Config. padrão válvula incêndio', tags: 3, time: 2, max: 1 },
                        'cfg_controle_2_elementos': { label: 'Controle dois elementos', tags: 9, time: 4, max: 1 },
                        'cfg_valvula_modulante': { label: 'Válvula modulante nível (PID)', tags: 16, time: 3, max: 1 },
                        'cfg_pi_exaustor': { label: 'Configurações PI exaustor', tags: 12, time: 2.5, max: 1 },
                        'cfg_pi_combustao': { label: 'Configurações PI combustão', tags: 14, time: 2.5, max: 1 },
                        'cfg_acendimento_auto': { label: 'Acendimento Automático', tags: 42, time: 8, max: 1 },
                        'cfg_silo_cavaco': { label: 'Operação silo Cavaco', tags: 10, time: 4, max: 1 }
                    }
                },
                'ajustes': {
                    label: 'Outros Ajustes',
                    items: {
                        'ajuste_alarme': { label: 'Configurações alarme', tags: 5, time: 1 },
                        'ajuste_receitas': { label: 'Ajuste padrão (nº de receitas)', tags: 4, time: 1.5 },
                        'ajuste_motores_receita': { label: 'Motores que fazem parte da receita', tags: 3, time: 0.5 },
                        'ajuste_partida_direta': { label: 'Nº de partidas direta (Dados Placa)', tags: 3, time: 0.25 },
                        'ajuste_unid_hidraulica': { label: 'Nº de partidas com unid. hidráulica', tags: 10, time: 0.5 },
                        'ajuste_patio_movel': { label: 'Configurações pátio móvel', tags: 3, time: 2 },
                        'tags_adicionais': { label: 'Tags Adicionais', tags: 1, time: 0.1 }
                    }
                }
            },
            licenses: {
                'Lite': [ { tags: 100, price: 2000 }, { tags: 250, price: 3500 }, { tags: 500, price: 5500 }, { tags: 750, price: 6500 }, { tags: 950, price: 8000 } ],
                'Server': [ { tags: 1000, price: 16000 }, { tags: 2500, price: 22000 }, { tags: 5000, price: 32000 }, { tags: 10000, price: 45000 } ]
            },
            hardware: {
                computers: [
                    { name: 'PC Básico (i5)', spec: 'I5, 16GB RAM, SSD 512GB + 1TB HDD', tagsLimit: 750, screenLimit: 2, price: 7500 },
                    { name: 'PC Avançado (i7)', spec: 'I7, 32GB RAM, SSD 512GB + 2TB HDD', tagsLimit: Infinity, screenLimit: Infinity, price: 13500 }
                ],
                videoCards: [
                    { name: "Placa 4 Saídas", screens: 4, price: 6500 }, { name: "Placa 6 Saídas", screens: 6, price: 10500 }, { name: "Placa 8 Saídas", screens: 8, price: 22000 }, { name: "Placa 10 Saídas", screens: 10, price: 35000 }
                ],
                screens: [
                    { name: '24" Full HD', price: 1500 }, { name: '32" Full HD', price: 2000 }, { name: '40" Full HD', price: 3000 }, { name: '55" Full HD', price: 5000 }
                ]
            },
            modules: {
                'energia': { label: 'Energia', hardware: 3600, tags: 150, time: 50 },
                'email': { label: 'Email', hardware: 1200, tags: 200, time: 150 },
                'app_movel': { label: 'App Movel', hardware: 3500, tags: 50, time: 80 },
                'indicadores': { label: 'Indicadores Avançados', hardware: 0, tags: 100, time: 220 },
                'historico': { label: 'Histórico Avançados', hardware: 3000, tags: 200, time: 440 },
                'erp': { label: 'Integração com ERP', hardware: 10000, tags: 50, time: 600 },
                'epm': { label: 'EPM Portal Web', hardware: 18000, tags: 500, time: 440 },
                'manutencao': { label: 'Modulo Manutenção Preditiva', hardware: 0, tags: 500, time: 800 },
                'pdf': { label: 'Relatorios PDF Personalizados', hardware: 0, tags: 50, time: 100 },
                'excel': { label: 'Relatorios Excel Personalizados', hardware: 0, tags: 50, time: 100 }
            }
        };

        // --- DOM ELEMENTS ---
        let grandTotalEl, baseTagsEl, reserveTagsEl, totalHoursEl, licenseNameEl, licensePriceEl, servicesPriceEl, projectTotalPriceEl, computerNameEl, screensDescEl, videocardDescEl, hardwareTotalPriceEl, moduleHardwarePriceEl, travelCostEl, lodgingCostEl, foodCostEl, travelTotalPriceEl, clearButton, pdfButton, tagsForm, calculatorFieldsContainer, settingsFieldsContainer, licenseSettingsContainer, hardwareSettingsContainer, moduleSettingsContainer, calculatorProjectInputsContainer, saveSettingsButton, restoreDefaultsButton, themeSwitcher, sunIcon, moonIcon, ctx, tagsChart, modulesContainer;
        
        // --- CHART ---
        const chartGroupColors = {
            'Motores': '#3b82f6', 'Instrumentos': '#10b981',
            'Válvulas e Dampers': '#ef4444', 'Configurações e Controles': '#f97316',
            'Outros Ajustes': '#a855f7', 'Módulos Opcionais': '#8b5cf6'
        };

        // --- FUNCTIONS ---
        function openTab(evt, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            if(evt) evt.currentTarget.classList.add('active');
            else document.querySelector(`[onclick="openTab(event, '${tabName}')"]`).classList.add('active');
        }
        
        function renderCalculatorFields() {
            let itemsHtml = '';
            for (const groupKey in database.tags) {
                itemsHtml += `<div class="glass-card">`;
                const group = database.tags[groupKey];
                itemsHtml += `<fieldset class="border-none p-0"><legend class="text-lg font-semibold mb-2">${group.label}</legend>`;
                itemsHtml += `<div class="calc-grid-header"><span>Descrição do Objeto</span><span class="text-center">Tags</span><span class="text-center">Horas</span><span class="text-center">Qtd.</span></div>`;
                for (const itemKey in group.items) {
                    const item = group.items[itemKey];
                    itemsHtml += `<div class="input-row">
                                <label for="calc_${itemKey}">${item.label}</label>
                                <span class="tags-per-item">${item.tags}</span>
                                <span class="time-per-item">${item.time}h</span>
                                <div class="flex justify-center">`;
                    if (item.max === 1) {
                        itemsHtml += `<label class="toggle-switch">
                                    <input type="checkbox" id="calc_${itemKey}" data-group="${group.label}" data-item-key="${itemKey}">
                                    <span class="slider"></span>
                                </label>`;
                    } else {
                        itemsHtml += `<input type="number" min="0" class="w-20" id="calc_${itemKey}" data-group="${group.label}" data-item-key="${itemKey}" placeholder="Qtd.">`;
                    }
                    itemsHtml += `</div></div>`;
                }
                itemsHtml += `</fieldset></div>`;
            }
            calculatorFieldsContainer.innerHTML = itemsHtml;

            // Render Modules
            let moduleHtml = `<div class="glass-card"><fieldset class="border-none p-0"><legend class="text-lg font-semibold mb-2">Módulos Opcionais</legend>`;
            for(const key in database.modules) {
                const module = database.modules[key];
                 moduleHtml += `<div class="project-input-row !grid-cols-2">
                                <label for="module_${key}">${module.label}</label>
                                <div class="flex justify-end">
                                    <label class="toggle-switch">
                                        <input type="checkbox" id="module_${key}" data-module-key="${key}">
                                        <span class="slider"></span>
                                    </label>
                                </div>
                              </div>`;
            }
            moduleHtml += `</fieldset></div>`;
            modulesContainer.innerHTML = moduleHtml;
        }
        
        function renderProjectInputs() {
            let projectHtml = `<div class="glass-card"><fieldset class="border-none p-0"><legend class="text-lg font-semibold mb-2">Configurações Iniciais do Projeto</legend>`;
            projectHtml += `<div class="project-input-row"><label for="calc_company_name">Nome da Empresa</label><input class="!text-left" type="text" id="calc_company_name" data-prop="companyName" value="${database.projectSettings.companyName}"></div>`;
            projectHtml += `<div class="project-input-row"><label for="calc_project_name">Nome do Projeto</label><input class="!text-left" type="text" id="calc_project_name" data-prop="projectName" value="${database.projectSettings.projectName}"></div>`;
            projectHtml += `<div class="project-input-row two-col-row"><div class="flex flex-col"><label for="calc_city">Cidade</label><input class="!text-left" type="text" id="calc_city" data-prop="city" value="${database.projectSettings.city}"></div><div class="flex flex-col"><label for="calc_state">Estado</label><input class="!text-left" type="text" id="calc_state" data-prop="state" value="${database.projectSettings.state}"></div></div>`;
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_reserve">Percentual de Reserva de Tags (%)</label><input type="number" min="0" id="calc_reserve" data-prop="reservePercentage" value="${database.projectSettings.reservePercentage}"></div>`;
            projectHtml += `<hr class="my-2 border-[var(--border-color)]">`
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_distance">Distância até Cliente (KM) (Calcula ida e volta)</label><input type="number" min="0" id="calc_distance" data-prop="distance" value="${database.projectSettings.distance}"></div>`;
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_lodging">Número de Hospedagens</label><input type="number" min="0" id="calc_lodging" data-prop="lodgingCount" value="${database.projectSettings.lodgingCount}"></div>`;
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_food">Número de Diárias (Alimentação)</label><input type="number" min="0" id="calc_food" data-prop="foodDays" value="${database.projectSettings.foodDays}"></div>`;
            projectHtml += `<hr class="my-2 border-[var(--border-color)]">`
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_screen_count">Número de Monitores</label><input type="number" min="0" id="calc_screen_count" data-prop="screenCount" value="${database.projectSettings.screenCount}"></div>`;
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_screen_model">Modelo da Tela</label><select id="calc_screen_model" data-prop="screenModelIndex">`;
            database.hardware.screens.forEach((screen, index) => {
                const selected = index === database.projectSettings.screenModelIndex ? 'selected' : '';
                projectHtml += `<option value="${index}" ${selected}>${screen.name}</option>`;
            });
            projectHtml += `</select></div>`;
            projectHtml += `<div class="project-input-row !grid-cols-2"><label for="calc_include_computer">Incluir Computador?</label><div class="flex justify-end"><label class="toggle-switch">
                                    <input type="checkbox" id="calc_include_computer" data-prop="includeComputer" ${database.projectSettings.includeComputer ? 'checked' : ''}>
                                    <span class="slider"></span>
                                </label></div></div>`;
            projectHtml += `</fieldset></div>`;
            calculatorProjectInputsContainer.innerHTML = projectHtml;
        }

        function renderSettingsFields() {
            // Render Tag Settings
            let tagHtml = `<div class="settings-grid-header"><span>Descrição do Objeto</span><span class="text-center">Tags</span><span class="text-center">Horas</span></div>`;
            for (const groupKey in database.tags) {
                const group = database.tags[groupKey];
                tagHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">${group.label}</legend>`;
                for (const itemKey in group.items) {
                    const item = group.items[itemKey];
                     tagHtml += `
                        <div class="settings-row">
                            <label for="setting_tags_${itemKey}">${item.label}</label>
                            <input type="number" min="0" id="setting_tags_${itemKey}" data-group-key="${groupKey}" data-item-key="${itemKey}" data-prop="tags" value="${item.tags}">
                            <input type="number" min="0" step="0.1" id="setting_time_${itemKey}" data-group-key="${groupKey}" data-item-key="${itemKey}" data-prop="time" value="${item.time}">
                        </div>`;
                }
                 tagHtml += `</fieldset>`;
            }
            settingsFieldsContainer.innerHTML = tagHtml;
            
            // Render Module Settings
            let moduleHtml = `<div class="settings-grid-header module-settings-header"><span>Módulo Opcional</span><span class="text-center">Hardware (R$)</span><span class="text-center">Tags</span><span class="text-center">Horas</span></div>`;
            moduleHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">Módulos</legend>`;
            for (const key in database.modules) {
                const module = database.modules[key];
                moduleHtml += `<div class="settings-row module-settings-row">
                                <label for="setting_module_label_${key}">${module.label}</label>
                                <input type="number" min="0" id="setting_module_hardware_${key}" data-type="modules" data-key="${key}" data-prop="hardware" value="${module.hardware}">
                                <input type="number" min="0" id="setting_module_tags_${key}" data-type="modules" data-key="${key}" data-prop="tags" value="${module.tags}">
                                <input type="number" min="0" step="0.1" id="setting_module_time_${key}" data-type="modules" data-key="${key}" data-prop="time" value="${module.time}">
                               </div>`;
            }
            moduleHtml += `</fieldset>`;
            moduleSettingsContainer.innerHTML = moduleHtml;

            // Render License Settings
            let licenseHtml = `<div class="settings-grid-header"><span>Pacote de Licença</span><span class="text-center">Tags</span><span class="text-center">Valor (R$)</span></div>`;
            for(const type in database.licenses) {
                licenseHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">${type}</legend>`;
                database.licenses[type].forEach((license, index) => {
                    licenseHtml += `
                        <div class="settings-row">
                            <label for="license_${type}_${index}">Pacote ${type} ${index + 1}</label>
                            <input type="number" min="0" id="license_tags_${type}_${index}" data-type="${type}" data-index="${index}" data-prop="tags" value="${license.tags}">
                            <input type="number" min="0" id="license_price_${type}_${index}" data-type="${type}" data-index="${index}" data-prop="price" value="${license.price}">
                        </div>
                    `;
                });
                licenseHtml += `</fieldset>`;
            }
            licenseSettingsContainer.innerHTML = licenseHtml;
            
            // Render Hardware Settings
            let hardwareHtml = `<div class="settings-grid-header" style="grid-template-columns: 1fr 100px; gap: 1rem;"><span>Item</span><span class="text-center">Valor (R$)</span></div>`;
            hardwareHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">Custos Gerais e de Viagem</legend>`;
            hardwareHtml += `<div class="settings-row"><label for="setting_hour_price">Valor da Hora de Serviço (R$)</label><input type="number" min="0" id="setting_hour_price" data-prop="hourPrice" value="${database.projectSettings.hourPrice}"></div>`;
            hardwareHtml += `<div class="settings-row"><label for="setting_km_price">Valor do KM Rodado (R$)</label><input type="number" min="0" id="setting_km_price" data-prop="kmPrice" value="${database.projectSettings.kmPrice}"></div>`;
            hardwareHtml += `<div class="settings-row"><label for="setting_lodging_price">Valor da Hospedagem (Diária)</label><input type="number" min="0" id="setting_lodging_price" data-prop="lodgingPrice" value="${database.projectSettings.lodgingPrice}"></div>`;
            hardwareHtml += `<div class="settings-row"><label for="setting_food_price">Valor da Alimentação (Diária)</label><input type="number" min="0" id="setting_food_price" data-prop="foodPrice" value="${database.projectSettings.foodPrice}"></div>`;
            hardwareHtml += `</fieldset>`;

            hardwareHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">Computadores</legend>`;
            database.hardware.computers.forEach((computer, index) => {
                 hardwareHtml += `<div class="settings-row vc-settings-row" style="grid-template-columns: 0.5fr 1.5fr 100px"><label>${computer.name}</label><input type="text" value="${computer.spec}" class="!text-left px-2" id="computer_spec_${index}" data-type="computers" data-index="${index}" data-prop="spec"><input type="number" min="0" id="computer_price_${index}" data-type="computers" data-index="${index}" data-prop="price" value="${computer.price}"></div>`;
            });
            hardwareHtml += `</fieldset>`;
            
            hardwareHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">Placas de Vídeo</legend>`;
            database.hardware.videoCards.forEach((vc, index) => {
                 hardwareHtml += `<div class="settings-row vc-settings-row"><label>${vc.screens} Saídas</label><input type="text" value="${vc.name}" id="vc_name_${index}" class="!text-left px-2" data-type="videoCards" data-index="${index}" data-prop="name"><input type="number" min="0" id="vc_price_${index}" data-type="videoCards" data-index="${index}" data-prop="price" value="${vc.price}"></div>`;
            });
            hardwareHtml += `</fieldset>`;

            hardwareHtml += `<fieldset class="border-none p-0 mb-4"><legend class="text-lg font-semibold mb-2">Telas</legend>`;
            database.hardware.screens.forEach((screen, index) => {
                 hardwareHtml += `<div class="settings-row"><label for="screen_name_${index}">${screen.name}</label><input type="number" min="0" id="screen_price_${index}" data-type="screens" data-index="${index}" data-prop="price" value="${screen.price}"><span/></div>`;
            });
            hardwareHtml += `</fieldset>`;
            hardwareSettingsContainer.innerHTML = hardwareHtml;

        }

        function calculateAndDisplayTotals() {
            let baseTotalTags = 0;
            let totalHours = 0;
            const groupTotals = {};
            
            // Get values from Project Settings
            const projectInputs = document.querySelectorAll('#calculator-project-inputs input, #calculator-project-inputs select');
            let tempProjectSettings = {};
             projectInputs.forEach(input => {
                const prop = input.dataset.prop;
                if (input.type === 'checkbox') {
                    tempProjectSettings[prop] = input.checked;
                } else if(input.type === 'text') {
                     tempProjectSettings[prop] = input.value;
                } else {
                    tempProjectSettings[prop] = parseFloat(input.value) || 0;
                }
            });

            const reservePercentage = tempProjectSettings.reservePercentage;
            const screenCount = tempProjectSettings.screenCount;
            const screenModelIndex = tempProjectSettings.screenModelIndex;
            const includeComputer = tempProjectSettings.includeComputer;
            const distance = tempProjectSettings.distance;
            const lodgingCount = tempProjectSettings.lodgingCount;
            const foodDays = tempProjectSettings.foodDays;

            const screenModelSelect = document.getElementById('calc_screen_model');

            // Calculate from core items
            document.querySelectorAll('#calculator-fields-container input').forEach(input => {
                let quantity = 0;
                if(input.type === 'checkbox') {
                    quantity = input.checked ? 1 : 0;
                } else if (input.type === 'number') {
                    quantity = parseFloat(input.value) || 0;
                }

                if (quantity > 0) {
                    const itemKey = input.dataset.itemKey;
                    const groupLabel = input.dataset.group;
                    const groupKey = Object.keys(database.tags).find(key => database.tags[key].label === groupLabel);
                    
                    if (groupKey && database.tags[groupKey].items[itemKey]) {
                        const itemData = database.tags[groupKey].items[itemKey];
                        const itemTotalTags = quantity * (itemData.tags || 0);
                        baseTotalTags += itemTotalTags;
                        totalHours += quantity * (itemData.time || 0);
                        
                        if (!groupTotals[groupLabel]) groupTotals[groupLabel] = 0;
                        groupTotals[groupLabel] += itemTotalTags;
                    }
                }
            });
            
            // Calculate from optional modules
            let modulesHardwareCost = 0;
            const moduleInputs = document.querySelectorAll('#modules-container input[type="checkbox"]');
            moduleInputs.forEach(input => {
                if (input.checked) {
                    const moduleKey = input.dataset.moduleKey;
                    const moduleData = database.modules[moduleKey];
                    if(moduleData) {
                        baseTotalTags += moduleData.tags;
                        totalHours += moduleData.time;
                        modulesHardwareCost += moduleData.hardware;
                        if (!groupTotals['Módulos Opcionais']) groupTotals['Módulos Opcionais'] = 0;
                        groupTotals['Módulos Opcionais'] += moduleData.tags;
                    }
                }
            });

            const reserveTags = Math.ceil(baseTotalTags * (reservePercentage / 100));
            const finalTotalTags = baseTotalTags + reserveTags;

            // Update Tags and Time Summary
            grandTotalEl.textContent = finalTotalTags;
            baseTagsEl.textContent = baseTotalTags;
            reserveTagsEl.textContent = reserveTags;
            totalHoursEl.textContent = totalHours.toFixed(1);
            updateChart(groupTotals);

            // Calculate Hardware
            const computer = database.hardware.computers.find(c => finalTotalTags <= c.tagsLimit && screenCount <= c.screenLimit) || database.hardware.computers[1];
            const computerCost = includeComputer ? computer.price : 0;
            const computerNameText = includeComputer ? computer.name : "Fornecido pelo Cliente";
            
            let videoCard = { price: 0, name: 'N/A' };
            if (screenCount > 2) {
                videoCard = database.hardware.videoCards.find(vc => screenCount <= vc.screens) || database.hardware.videoCards[database.hardware.videoCards.length - 1];
            }

            let screensCost = 0;
            let screensDescText = 'N/A (Cliente já possui)';
            if (screenCount > 0) {
                const screen = database.hardware.screens[screenModelIndex];
                screensCost = screen.price * screenCount;
                screensDescText = `${screenCount}x ${screen.name}`;
                if (screenModelSelect) screenModelSelect.disabled = false;
            } else {
                 if (screenModelSelect) screenModelSelect.disabled = true;
            }

            const hardwareTotalCost = computerCost + videoCard.price + screensCost + modulesHardwareCost;
            
            // Update Hardware Summary
            computerNameEl.textContent = computerNameText;
            screensDescEl.textContent = screensDescText;
            videocardDescEl.textContent = videoCard.name;
            moduleHardwarePriceEl.textContent = formatCurrency(modulesHardwareCost);
            hardwareTotalPriceEl.textContent = formatCurrency(hardwareTotalCost);
            
            // Calculate Travel Expenses
            const travelCost = distance * 2 * database.projectSettings.kmPrice;
            const lodgingCost = lodgingCount * database.projectSettings.lodgingPrice;
            const foodCost = foodDays * database.projectSettings.foodPrice;
            const travelTotalCost = travelCost + lodgingCost + foodCost;

            // Update Travel Summary
            travelCostEl.textContent = formatCurrency(travelCost);
            lodgingCostEl.textContent = formatCurrency(lodgingCost);
            foodCostEl.textContent = formatCurrency(foodCost);
            travelTotalPriceEl.textContent = formatCurrency(travelTotalCost);

            // Calculate License and Final Price
            const recommendedLicense = calculateRecommendedLicense(finalTotalTags);
            const totalServicesPrice = totalHours * database.projectSettings.hourPrice;
            const finalProjectPrice = recommendedLicense.price + totalServicesPrice + hardwareTotalCost + travelTotalCost;

            licenseNameEl.textContent = recommendedLicense.name;
            licensePriceEl.textContent = formatCurrency(recommendedLicense.price);
            servicesPriceEl.textContent = formatCurrency(totalServicesPrice);
            projectTotalPriceEl.textContent = formatCurrency(finalProjectPrice);
        }
        
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(value);
        }

        function calculateRecommendedLicense(totalTags) {
            if (totalTags === 0) {
                return { name: 'N/A', price: 0 };
            }

            const allLicenses = [...database.licenses.Lite, ...database.licenses.Server].sort((a,b) => a.tags - b.tags);
            const suitableLicense = allLicenses.find(l => l.tags >= totalTags);

            if (!suitableLicense) {
                const largestLicense = allLicenses[allLicenses.length - 1];
                return { name: `Acima de ${largestLicense.tags} Tags`, price: largestLicense.price };
            }
            
            const type = database.licenses.Lite.includes(suitableLicense) ? 'Lite' : 'Server';
            return { name: `${type} - ${suitableLicense.tags} Tags`, price: suitableLicense.price };
        }

        function saveSettings() {
            // Save tag and time settings
            const settingsInputs = settingsFieldsContainer.querySelectorAll('input[type="number"], input[type="text"]');
            settingsInputs.forEach(input => {
                const groupKey = input.dataset.groupKey;
                const itemKey = input.dataset.itemKey;
                const prop = input.dataset.prop;
                const newValue = input.type === 'text' ? input.value : (parseFloat(input.value) || 0);
                if (database.tags[groupKey] && database.tags[groupKey].items[itemKey]) {
                    database.tags[groupKey].items[itemKey][prop] = newValue;
                }
            });

            // Save license settings
            const licenseInputs = licenseSettingsContainer.querySelectorAll('input[type="number"]');
            licenseInputs.forEach(input => {
                const type = input.dataset.type;
                const index = input.dataset.index;
                const prop = input.dataset.prop;
                const newValue = parseInt(input.value) || 0;
                if(database.licenses[type] && database.licenses[type][index]) {
                    database.licenses[type][index][prop] = newValue;
                }
            });
            
             // Save module settings
            const moduleInputs = moduleSettingsContainer.querySelectorAll('input');
            moduleInputs.forEach(input => {
                const key = input.dataset.key;
                const prop = input.dataset.prop;
                 const newValue = input.type === 'text' ? input.value : (parseFloat(input.value) || 0);
                if(database.modules[key]){
                     database.modules[key][prop] = newValue;
                }
            });

            // Save hardware settings
            const hardwareInputs = hardwareSettingsContainer.querySelectorAll('input, select');
            hardwareInputs.forEach(input => {
                const type = input.dataset.type;
                const index = input.dataset.index;
                const prop = input.dataset.prop;
                const newValue = input.type === 'text' ? input.value : (parseFloat(input.value) || 0);

                if(database.hardware[type] && database.hardware[type][index]){
                     database.hardware[type][index][prop] = newValue;
                } else if (prop === 'hourPrice' || prop === 'kmPrice' || prop === 'lodgingPrice' || prop === 'foodPrice') {
                    database.projectSettings[prop] = newValue;
                }
            });
            
            // Save project settings from calculator tab
            const projectInputs = document.querySelectorAll('#calculator-project-inputs input, #calculator-project-inputs select');
            projectInputs.forEach(input => {
                const prop = input.dataset.prop;
                if (input.type === 'checkbox') {
                    database.projectSettings[prop] = input.checked;
                } else if (input.type === 'text') {
                    database.projectSettings[prop] = input.value;
                } else {
                    const newValue = parseFloat(input.value) || 0;
                    database.projectSettings[prop] = newValue;
                }
            });

            localStorage.setItem('database', JSON.stringify(database));
            alert('Configurações salvas com sucesso!');
            rerenderAll();
        }
        
        function restoreDefaults() {
            if (confirm('Tem certeza que deseja restaurar os valores padrão? Todas as suas alterações serão perdidas.')) {
                localStorage.removeItem('database');
                loadData();
                rerenderAll();
                alert('Valores padrão restaurados.');
            }
        }

        function loadData() {
            const savedData = localStorage.getItem('database');
            let parsedData = savedData ? JSON.parse(savedData) : JSON.parse(JSON.stringify(defaultDatabase));
            
            // Migration for old data structures and new fields
             database = {
                ...JSON.parse(JSON.stringify(defaultDatabase)),
                ...parsedData,
                projectSettings: {
                    ...JSON.parse(JSON.stringify(defaultDatabase.projectSettings)),
                    ...(parsedData.projectSettings || {})
                },
                tags: parsedData.tags || JSON.parse(JSON.stringify(defaultDatabase.tags)),
                licenses: parsedData.licenses || JSON.parse(JSON.stringify(defaultDatabase.licenses)),
                hardware: parsedData.hardware || JSON.parse(JSON.stringify(defaultDatabase.hardware)),
                modules: parsedData.modules || JSON.parse(JSON.stringify(defaultDatabase.modules)),
             };

             for (const key in defaultDatabase.hardware.videoCards) {
                if(database.hardware.videoCards[key] && !database.hardware.videoCards[key].name) {
                     database.hardware.videoCards[key].name = defaultDatabase.hardware.videoCards[key].name;
                }
            }
        }
        
        function rerenderAll() {
            renderProjectInputs();
            renderCalculatorFields();
            renderSettingsFields();
            calculateAndDisplayTotals();
        }

        function initializeChart() {
            if (!ctx) return;
            tagsChart = new Chart(ctx, {
                type: 'doughnut', data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 0 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark-theme') ? '#f5f5f5' : '#4a5568', font: { family: "'Inter', sans-serif" }, padding: 15, boxWidth: 12, usePointStyle: true, pointStyle: 'circle' }}}}
            });
        }

        function updateChart(groupTotals) {
            if (!tagsChart) return;
            const labels = Object.keys(groupTotals);
            const data = Object.values(groupTotals);
            tagsChart.data.labels = labels;
            tagsChart.data.datasets[0].data = data;
            tagsChart.data.datasets[0].backgroundColor = labels.map(label => chartGroupColors[label] || '#9ca3af');
            tagsChart.update();
        }

        function applyTheme(theme) {
            if (theme === 'dark') {
                document.body.classList.add('dark-theme');
                sunIcon.classList.add('hidden');
                moonIcon.classList.remove('hidden');
            } else {
                document.body.classList.remove('dark-theme');
                sunIcon.classList.remove('hidden');
                moonIcon.classList.add('hidden');
            }
            if(tagsChart) {
                tagsChart.options.plugins.legend.labels.color = theme === 'dark' ? '#f5f5f5' : '#4a5568';
                tagsChart.update();
            }
        }

        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-theme') ? 'dark' : 'light';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            localStorage.setItem('theme', newTheme);
            applyTheme(newTheme);
        }
        
        function generatePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Get current project settings from inputs
            const companyName = document.getElementById('calc_company_name').value || 'N/A';
            const projectName = document.getElementById('calc_project_name').value || 'N/A';
            const city = document.getElementById('calc_city').value || 'N/A';
            const state = document.getElementById('calc_state').value || 'N/A';

            const finalTotalTags = grandTotalEl.textContent;
            const baseTagsValue = baseTagsEl.textContent;
            const reserveTagsValue = reserveTagsEl.textContent;
            const totalHoursValue = totalHoursEl.textContent;

            const hardwareTotal = hardwareTotalPriceEl.textContent;
            const travelTotal = travelTotalPriceEl.textContent;
            const licenseName = licenseNameEl.textContent;
            const licenseCost = licensePriceEl.textContent;
            const servicesCost = servicesPriceEl.textContent;
            const projectTotal = projectTotalPriceEl.textContent;

            const chartBase64 = tagsChart ? tagsChart.toBase64Image() : null;

            // --- PDF STYLING ---
            const primaryColor = '#14b8a6';
            const secondaryColor = '#4a5568';
            const pageW = doc.internal.pageSize.getWidth();
            const margin = 14;
            let y = 20;

            // Header
            doc.setFontSize(22).setFont(undefined, 'bold');
            doc.text("Orçamento de Projeto de Supervisório", pageW / 2, y, { align: 'center' });
            y += 10;
            doc.setFontSize(10).setFont(undefined, 'normal');
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, pageW - margin, y, { align: 'right' });
            y += 8;

            // Section Title Helper
            const drawSectionTitle = (title) => {
                doc.setFillColor(primaryColor);
                doc.rect(margin, y, pageW - (margin * 2), 8, 'F');
                doc.setFontSize(12).setFont(undefined, 'bold').setTextColor('#FFFFFF');
                doc.text(title, margin + 3, y + 5.5);
                y += 12;
                doc.setTextColor('#000000');
            };
            
            // Client/Project Info
            drawSectionTitle("Dados do Projeto");
            doc.setFontSize(10).setFont(undefined, 'normal');
            doc.text(`Empresa: ${companyName}`, margin, y);
            doc.text(`Local: ${city}, ${state}`, pageW / 2, y);
            y += 6;
            doc.text(`Projeto: ${projectName}`, margin, y);
            y += 10;
            
            // Summary Cards
            const drawSummaryCard = (x, width, title, value, subtext = null) => {
                doc.setFillColor(244, 247, 249);
                doc.setDrawColor(222, 226, 230);
                doc.roundedRect(x, y, width, 22, 3, 3, 'FD');
                doc.setFontSize(10).setTextColor(secondaryColor);
                doc.text(title, x + width / 2, y + 7, { align: 'center' });
                doc.setFontSize(18).setFont(undefined, 'bold').setTextColor('#000000');
                doc.text(value, x + width / 2, y + 14, { align: 'center' });
                 if (subtext) {
                    doc.setFontSize(8).setFont(undefined, 'normal').setTextColor(secondaryColor);
                    doc.text(subtext, x + width / 2, y + 19, { align: 'center' });
                }
            };

            const cardWidth = (pageW - margin * 2 - 10) / 2;
            drawSummaryCard(margin, cardWidth, "Total de Tags", finalTotalTags, `Projeto: ${baseTagsValue} + Reserva: ${reserveTagsValue}`);
            drawSummaryCard(margin + cardWidth + 10, cardWidth, "Total de Horas", `${totalHoursValue}h`);
            y += 30;

            // Costs Breakdown
            drawSectionTitle("Detalhamento de Custos");
            const costX = margin + 5;
            let costY = y;
            const drawCostItem = (label, value) => {
                doc.setFontSize(10).setFont(undefined, 'bold');
                doc.text(label, costX, costY);
                doc.setFont(undefined, 'normal');
                doc.text(value, costX + 70, costY);
                costY += 7;
            }
            drawCostItem("Valor dos Serviços:", servicesCost);
            drawCostItem("Custo da Licença:", licenseCost);
            drawCostItem("Custo de Hardware:", hardwareTotal);
            drawCostItem("Despesas de Viagem:", travelTotal);
            
            y = Math.max(y + 5, costY);

            // Final Total
            doc.setDrawColor(primaryColor);
            doc.line(margin, y, pageW - margin, y);
            y += 10;
            doc.setFontSize(16).setFont(undefined, 'bold');
            doc.text("Valor Total do Projeto:", margin, y);
            doc.text(projectTotal, pageW - margin, y, { align: 'right' });


            // Footer
            const pageCount = doc.internal.getNumberOfPages();
            for (let i = 1; i <= pageCount; i++) {
                doc.setPage(i);
                doc.setFontSize(8).setTextColor(secondaryColor);
                doc.text(`Versão 12.0 - by Diego Karloh`, margin, 287);
                doc.text(`Página ${i} de ${pageCount}`, pageW / 2, 287, { align: 'center' });
            }

            doc.save(`Orçamento - ${projectName || 'Novo Projeto'}.pdf`);
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            // Assign DOM elements
            grandTotalEl = document.getElementById('grand-total');
            baseTagsEl = document.getElementById('base-tags');
            reserveTagsEl = document.getElementById('reserve-tags');
            totalHoursEl = document.getElementById('total-hours');
            licenseNameEl = document.getElementById('license-name');
            licensePriceEl = document.getElementById('license-price');
            servicesPriceEl = document.getElementById('services-price');
            projectTotalPriceEl = document.getElementById('project-total-price');
            computerNameEl = document.getElementById('computer-name');
            screensDescEl = document.getElementById('screens-desc');
            videocardDescEl = document.getElementById('videocard-desc');
            hardwareTotalPriceEl = document.getElementById('hardware-total-price');
            moduleHardwarePriceEl = document.getElementById('module-hardware-price');
            travelCostEl = document.getElementById('travel-cost');
            lodgingCostEl = document.getElementById('lodging-cost');
            foodCostEl = document.getElementById('food-cost');
            travelTotalPriceEl = document.getElementById('travel-total-price');
            clearButton = document.getElementById('clear-button');
            pdfButton = document.getElementById('pdf-button');
            tagsForm = document.getElementById('tags-form');
            calculatorFieldsContainer = document.getElementById('calculator-fields-container');
            modulesContainer = document.getElementById('modules-container');
            calculatorProjectInputsContainer = document.getElementById('calculator-project-inputs');
            settingsFieldsContainer = document.getElementById('settings-fields');
            licenseSettingsContainer = document.getElementById('license-settings-fields');
            hardwareSettingsContainer = document.getElementById('hardware-settings-fields');
            moduleSettingsContainer = document.getElementById('module-settings-fields');
            saveSettingsButton = document.getElementById('save-settings-button');
            restoreDefaultsButton = document.getElementById('restore-defaults-button');
            themeSwitcher = document.getElementById('theme-switcher');
            sunIcon = document.getElementById('sun-icon');
            moonIcon = document.getElementById('moon-icon');
            ctx = document.getElementById('tagsChart')?.getContext('2d');
            
            loadData();
            initializeChart();
            rerenderAll();
            openTab(null, 'calculadora');

            const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            applyTheme(savedTheme);
            
            // Event Listeners
            tagsForm.addEventListener('input', calculateAndDisplayTotals);
            
            clearButton.addEventListener('click', () => {
                const defaultSettings = JSON.parse(JSON.stringify(defaultDatabase.projectSettings));
                database.projectSettings = defaultSettings;
                tagsForm.reset();
                // manually update the UI from the now-reset database state
                rerenderAll(); 
            });
            saveSettingsButton.addEventListener('click', saveSettings);
            restoreDefaultsButton.addEventListener('click', restoreDefaults);
            themeSwitcher.addEventListener('click', toggleTheme);
            pdfButton.addEventListener('click', generatePDF);
        });
    </script>
</body>
</html>
